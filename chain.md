# Chain

## Longest Chain

### **比特幣中最長鏈存儲在哪裡？**  
比特幣中的最長鏈並不存儲在單一位置，而是 **複製到比特幣網絡中的所有完整節點**。每個完整節點都會保持 **整個區塊鏈的副本**，這包括從 **創世區塊** 到最新挖掘的區塊的所有有效區塊。

當節點收到新區塊時，它會檢查該區塊是否延伸了它所知道的最長有效鏈。如果是，節點會 **將該區塊附加到本地區塊鏈副本**。

---

### **如何確定最長鏈？**  
比特幣遵循 **中本共識**，其中 **最長鏈（或最積累的工作量證明）被認為是有效鏈**。這是通過以下方式確定的：

1. **完成的總工作量（不僅僅是區塊數量）**  
   - 最長鏈不僅僅是擁有最多區塊的鏈。
   - 它是擁有 **最多累積的工作量證明（PoW）** 的鏈，這意味著所有區塊的難度總和是最高的。

2. **難度與工作量證明（PoW）**  
   - 每個區塊頭都包含一個 **難度目標**。
   - 礦工必須找到一個有效的 **SHA-256 雜湊**，該雜湊低於此目標。
   - 區塊的挖掘難度越大，所代表的工作量越多。

3. **分叉處理（鏈重組）**  
   - 如果兩個礦工在相同高度找到不同的有效區塊，會發生 **臨時分叉**。
   - 節點最初會接受它們看到的第一個區塊。
   - 首先積累 **更多工作量證明** 的鏈將成為有效鏈。
   - 輸掉的分支（較短的鏈）將被丟棄（孤立區塊）。

---

### **當發現更長的鏈時會發生什麼？**
1. 節點驗證新最長鏈中的每個區塊。
2. 如果新鏈擁有更多工作量證明，節點將丟棄其先前的鏈。
3. 被丟棄區塊中的交易會被 **重新加入到內存池**（如果尚未在新鏈中確認）。
4. 網絡繼續擴展新的最長鏈。

---

## Bitcoin Network

## **礦工如何找到最長鏈？**
由於礦工不依賴中央權威機構，它們利用 **比特幣的P2P網絡** 來保持同步。以下是它如何運作：

### **1. 同行發現：礦工如何找到其他節點**
礦工首先必須連接到其他節點，以接收和分享區塊鏈數據。它們通過以下方式來做到這一點：
- **硬編碼的種子節點**：比特幣核心有一個已知的“種子節點”列表，幫助新節點發現其他節點。
- **DNS啟動**：新節點查詢特殊的DNS伺服器來獲取活躍的對等節點列表。
- **節點傳播（Gossiping）**：一旦連接，節點交換已知對等節點的列表（`addr` 訊息）。
- **連接請求**：節點可以手動連接到其他比特幣節點的已知IP地址。

礦工和節點保持 **8–125 個活躍連接** 來確保可靠的數據流動。

---

### **2. 接收最長鏈**
一旦連接，礦工會向其對等節點詢問：
1. **“你最新的區塊是什麼？”**（`getheaders` 訊息）
2. 對等節點回應其最新的區塊標頭。
3. 礦工比較鏈的 **累積工作量證明（PoW）**。
4. 如果發現更長的鏈，礦工請求缺失的區塊（`getdata` 訊息）。
5. 礦工驗證並更新其本地區塊鏈。

---

### **3. 隨時保持最新區塊**
當礦工成功挖掘出一個區塊時，它會 **廣播** 該區塊到網絡中：
- 新區塊會發送到所有已連接的對等節點（`inv` 和 `block` 訊息）。
- 每個對等節點 **驗證該區塊** 並進一步傳播它。
- 在幾秒鐘內，新區塊會遍佈整個網絡。

---

## **礦工如何知道所有可能的鏈？**
礦工並不知道 *所有* 可能的鏈—它們僅知道通過對等節點得知的鏈。然而，由於比特幣節點持續共享更新，所有礦工最終會達成共識，選擇同一條 **最長鏈**。

- 如果礦工暫時處於較短的鏈上，它將 **切換** 到更長的鏈，一旦它接收到足夠的區塊數據。
- 這就是為什麼有時會發生 **孤立區塊**（未進入最長鏈的區塊）。

---

## **為什麼這在沒有中央伺服器的情況下也能運作？**
比特幣使用一種 **分佈式共識** 機制：
1. **節點傳播資訊** → 不需要中央權威機構。
2. **工作量證明確保信任** → 最長鏈是有效鏈。
3. **自我修復網絡** → 節點自動同步。

--- 

## 交易紀錄的儲存

### 1. **比特幣節點類型**  
並非所有節點都儲存完整的區塊鏈。不同類型的節點有不同的存儲需求：

- **完整節點：**  
  - 儲存從創世區塊（2009年）到最新區塊的整個比特幣區塊鏈。  
  - 需要大量的磁碟空間（約500 GB以上）。  
  - 驗證並轉發交易和區塊到網絡。

- **修剪節點：**  
  - 只儲存最新的區塊，刪除舊的區塊以節省空間。  
  - 需要的存儲空間要小得多（例如，最低可為10 GB）。  
  - 仍然可以驗證新的交易。

- **輕量級（SPV）錢包：**  
  - 不儲存完整的區塊鏈。  
  - 只下載區塊頭（每個區塊大約80字節）。  
  - 依賴完整節點來驗證交易。

---

### 2. **數據存儲優化**  
比特幣核心使用多種技術來有效地存儲和管理區塊鏈數據：

- **修剪：** 節點可以在驗證交易後刪除舊的交易數據。
- **UTXO 集合存儲：** 節點不儲存所有過去的交易，而是只儲存 **未花費交易輸出（UTXO）**，這些是可支配的餘額。
- **壓縮區塊轉發：** 通過僅發送節點之間的交易差異來減少網絡帶寬，而不是發送整個區塊。

---

### 3. **分散式存儲方法**  
由於比特幣是去中心化的，不同的節點儲存區塊鏈的不同部分。然而：
- 沒有任何單一節點需要永遠儲存所有內容。
- 全球有許多完整節點，確保了冗餘性。
- 修剪節點和SPV錢包減少了普通用戶的存儲需求。

